-- delete all trigger
declare @cmd nvarchar(1000)
declare cmds cursor for
SELECT 'Drop Trigger ['+TRIG.name+']'+(case when parent_class_desc<>'DATABASE' then ''       
		    else ' on database' end) 
FROM db_Library.[sys].[triggers] as TRIG 
where TRIG.type = 'TR'
open cmds
while 1=1
begin
	fetch cmds into @cmd
	if @@FETCH_STATUS!=0 break;
	EXEC(@cmd);
end
close cmds;
deallocate cmds;

use db_Library

GO

-- ?? ??????? ?? ??????? ?????? ?? 
-- ????? ???? ?? ????? ???? ??? ??? ??? ?? ??? ???? ????? ???
create trigger tr_SaveTotalInsertedBookCopies
on db_library.dbo.BookCopies
after Insert ,delete
as 
begin
	declare @max int
	select @max=count(*) from BookCopies
	if(EXISTS(select * from BookCount))
	begin
		update BookCount set Count = @max
	end
	else
	begin
		insert into BookCount
		(count)
		Values
		(@max)
	end
end

GO

-- ????? ?? ??? BookLog ????? ???? Book ????? ???? ?? 2 ???? ????? ??: ) ????? ? ??? ??????( 
-- ?????? ????? ???? ?? ??????? ??? ??? ?? ???? Book ?? ?? ???? BookLog ?? ????? ????? 
-- ??? ? ????? ??? ????? ????? ???.
create trigger tr_BookLog
on db_Library.dbo.BookCopies
after delete
as
begin
	insert into BookCopyLogs (ISBN,BookId,PublisherId,PublishDate,Price,EditedVersion,DeletedStaffId,DeletedDateTime)
	select ISBN,BookId,PublisherId,PublishDate,Price,EditedVersion,4 as DeletedStaffId, getdate() as DeletedDateTime from deleted
end

GO

-- • ?????? ?? ????? ????? ?? ?????? ???? ?? ???? ?? ???? ?? ????.
create trigger tr_PreventCreateOrUpdateTable
on DATABASE
for Create_Table,ALTER_TABLE
as
begin
	print 'This operation does not allowed'
	rollback transaction
end

go 

-- ?????? ?? ??? ? ? insert ??????? ?? ???? Publisher ??? ?? ??? ??? ???? ?????? ?????. ??? ??? 
-- ???? ? ????? ??? ??? ????? ??? ? ??? ?????? ???? insert ?? ????? ???.
create trigger tr_CheckDuplicateInsertingPubliser
on db_Library.dbo.Publishers
after insert
as
begin
	if exists(select * from Publishers p where p.PublisherId<> (select PublisherId from inserted) and p.Name = (select name from inserted))
	begin
		print 'The name of new publisher is duplicate'
		rollback transaction
	end

end