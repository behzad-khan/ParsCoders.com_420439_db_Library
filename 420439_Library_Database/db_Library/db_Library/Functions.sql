-- Drop All Function
declare @cmd varchar(1000)
declare cmds cursor for
SELECT 'Drop function ['+name + ']'
FROM db_Library.sys.objects
WHERE type in ('FN', 'IF', 'FN', 'AF', 'FS', 'FT')

open cmds
while 1=1
begin
	fetch cmds into @cmd
	if @@FETCH_STATUS!=0 break
	EXEC(@cmd)
end
close cmds;
deallocate cmds;

use [db_Library]

go
-- ????? ??????? ?? ????? ???? ?? ?????? ???? ? ???? ???? ????? ?? ???? ?? ????????.
-- ????: ??? ? ??? ???????? ? ????? ????? ????? ?????? ????? ?????
create Function GetReadersListOfBook(@ISBN varchar(100))
returns table
	as
		return
			select p.Name, p.Family, rb.ReserveDateTime, bb.BorrowedDateTime,bb.ReturnDateTime
			from BorrowBookCopies bb 
			join Readers r on r.ReaderId = bb.ReaderId
			join People p on p.PersonId = r.ReaderId
			left join ReserveBookCopies rb on rb.ReserveId=bb.ReaderId
			where bb.ISBN = @ISBN

GO

-- ????? ??????? ?? ????? ??????? ?? ?????? ???? ? ???? ???? ??? ?? ????? ?? ?? ????????. ) ???? ???? 
-- ?? ???? ? ???? ???? ? ??? 
create function GetNotReturnedBooksOfReader(@ReaderId int)
returns table
as
	return
		select bb.ISBN,b.Title
		from BorrowBookCopies bb
		join BookCopies bc on bc.ISBN = bb.ISBN
		join Books b on b.BookId = bc.BookId
		where bb.ReaderId = @ReaderId and bb.ReturnDateTime is null

GO

-- • ????? ?? ????? ?????? ?? ?????? ???? ? ????? ???? ??? ????? ???? ?? ????????
create function GetBorrowedBooksOfStaff(@StaffId as int)
returns int
as
begin
    declare @return_value int
	select @return_value=count(*) 
			from BorrowBookCopies bb
			where bb.StaffId = @StaffId 
	return @return_value
end

GO

-- ????? ?? ?? ????? ?? ?????? ???? ? ???? ??? ??? ??? ??? ?? ????? ?? ????? ???.
create function GetPublishedBooksOfDateRange(@StartDate datetime, @EndDate datetime)
returns table
as
return
	select bc.ISBN, b.Title
	from BookCopies bc
	join Books b on b.BookId = bc.BookId
	where bc.PublishDate between @StartDate and @EndDate
