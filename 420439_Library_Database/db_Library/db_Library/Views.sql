-- delete all views
declare @cmd nvarchar(1000)
declare cmds cursor for
select 'drop view ['+Table_Name+']'
from INFORMATION_SCHEMA.VIEWS
where TABLE_CATALOG='db_Library'
open cmds
while 1=1
begin
	fetch cmds into @cmd
	if @@FETCH_STATUS!=0 break
	EXEC(@cmd)
end
close cmds;
deallocate cmds;
go

use db_Library
GO

-- ? ??? ????????? ? ????? ???? ? ?? ????? ????? ??? ) ??? ? ??? ???????? ? ????? ???? ( 
Create View dbo.V_ReadersBookBorrowCount
AS
select P.PersonId,P.Name,p.Family,(select count(*) from dbo.BorrowBookCopies bbc where bbc.ReaderId=r.ReaderId) as BookBorrowCount from dbo.Readers r
left join dbo.People p on r.ReaderId = p.PersonId
--left join dbo.BorrowBookCopies bbc on bbc.ReaderId = r.ReaderId
--group by P.PersonId,P.Name,p.Family

go

--• ???? ? ??? ?? ) ????? ????? ????? ??????? ????? ??? ????????? ????? ??????? ???? ( 
create view dbo.V_BookList
as
	select b.Title, bc.EditedVersion, c.Title as Category,p.Name as Publisher, bc.PublishDate, bc.Price  from BookCopies bc
	join Books b on b.BookId = bc.BookId
	Left join Categories c on c.CategoryId = b.CategoryId
	join Publishers p on p.PublisherId = bc.PublisherId

	go

-- • ???? ????????? ) ??? ? ??? ???????? ??????? ? ????? ???? ? ????? ????? ??????? (
create view dbo.V_AuthersList
as
	select p.Name,p.Family,bc.ISBN,b.Title as BookTitle,abc.OrderNumber 
	from Authers a
	join People p on p.PersonId = a.AutherId
	join AutherBookCopies abc on abc.AutherId = a.AutherId
	join BookCopies bc on bc.ISBN = abc.ISBN
	join Books b on b.BookId = bc.BookId
	--order by bc.ISBN, abc.OrderNumber

go
-- ???? ???????? ) ??? ? ??? ???????? ??????? ????? ???? ??? ??? ???????? ????? ???? ??? ????? ?????  ????? ???? ??? ?? ????? (
create view dbo.V_StaffsList
as
	select p.Name,p.Family, (select count(*) from StaffHoldBookCopies sh where sh.StaffId = s.StaffId) as TotalHoldBook,
		  (Select count(*) from BorrowBookCopies bb where bb.StaffId =s.StaffId) as TotalBorrowBook,
		  (Select count(*) from BorrowBookCopies bb where bb.StaffId = s.StaffId and ReturnDateTime is not null) as TotalReturnBook
	from Staffs s
	join People p on p.PersonId = s.StaffId
	